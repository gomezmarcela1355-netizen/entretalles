<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>ENTRETALLES – CARRITO</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root{ --azul-top:#1e4aa3; --azul-bottom:#315ec9; --rosa:#ff1493; --txt:#ffffff; --azul-btn:#0b2f6b; --azul-footer:#0d3385; }
*{box-sizing:border-box}
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#fff;color:#113}
header{background:linear-gradient(180deg,var(--azul-top),var(--azul-bottom));color:var(--txt);padding:24px 16px 28px}
.header-wrap{max-width:1080px;margin:0 auto;display:grid;grid-template-columns:180px 1fr 140px;gap:16px;align-items:center}
.logo{width:150px;height:auto;border-radius:10px;background:#fff;padding:18px;box-shadow:0 3px 10px rgba(0,0,0,.25)}
.brand{text-align:center}.brand h1{margin:0 0 6px;font-size:36px}.brand p{margin:0;opacity:.95}
.header-actions{display:flex;justify-content:flex-end;align-items:center;gap:10px}
.profile-btn{display:inline-flex;align-items:center;gap:8px;background:#ffffff20;color:#fff;border:1px solid #ffffff40;border-radius:999px;padding:8px 12px;cursor:pointer;text-decoration:none;font-weight:bold}
.profile-btn:hover{background:#ffffff30}
nav{background:var(--rosa);display:flex;justify-content:center;gap:28px;padding:10px 12px;font-weight:bold;position:relative}
nav a{color:#fff;text-decoration:none;padding:8px 14px;border-radius:999px}
nav a:hover{background:rgba(255,255,255,.18)}
#cart-count{display:none; position:absolute; top:-6px; right:-10px; background:#fff; color:#d6006e; border-radius:999px; padding:2px 6px; font-size:12px; font-weight:bold}

main{max-width:1080px;margin:24px auto 56px;padding:0 16px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:10px;border-bottom:1px solid #e6e6e6;text-align:left;vertical-align:middle}
.thumb{width:64px;height:64px;object-fit:cover;border-radius:8px;background:#fff}
.qty{display:flex;align-items:center;gap:6px}
.btn{background:var(--azul-btn);color:#fff;border:0;border-radius:8px;padding:8px 12px;text-decoration:none;cursor:pointer;font-weight:bold}
.btn.light{background:#e9eefc;color:#0b2f6b}
.row-actions{display:flex;gap:8px;flex-wrap:wrap}
.total-box{margin-top:16px;display:flex;justify-content:flex-end;gap:12px;align-items:center}
footer{background:var(--azul-footer);color:#fff;text-align:center;padding:22px 16px}
.social img{width:28px;margin:0 8px;vertical-align:middle}
@media(max-width:720px){
  .hide-sm{display:none}
  .table th:nth-child(3), .table td:nth-child(3){display:none}
}

/* Modal comprador */
.modal-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:2000;align-items:center;justify-content:center;padding:16px}
.modal{width:100%;max-width:520px;background:#fff;border-radius:14px;box-shadow:0 12px 34px rgba(0,0,0,.25);overflow:hidden}
.modal header{background:linear-gradient(180deg,var(--azul-top),var(--azul-bottom));color:#fff;padding:14px 16px}
.modal .content{padding:16px}
.form-row{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
.input{padding:10px;border:1px solid #cfd6ff;border-radius:8px;font-size:15px}
.form-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
.note{font-size:12px;color:#456}
.req{color:#d6006e}
</style>
</head>
<body>
<header>
  <div class="header-wrap">
    <img class="logo" src="https://i.postimg.cc/852rV0T7/Whats-App-Image-2025-03-26-at-12-46-00.jpg" alt="Logo">
    <div class="brand"><h1>ENTRETALLES</h1><p>Carrito</p></div>
    <div class="header-actions">
      <!-- Botón perfil (no obliga a registrarse, solo abre el modal para guardar datos) -->
      <button class="profile-btn" id="openProfile" title="Mis datos">
        <!-- iconito persona -->
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 12c2.9 0 5-2.1 5-5s-2.1-5-5-5-5 2.1-5 5 2.1 5 5 5Zm0 2c-4 0-8 2-8 6v2h16v-2c0-4-4-6-8-6Z" fill="white"/>
        </svg>
        <span>Mi cuenta</span>
      </button>
    </div>
  </div>
</header>

<nav>
  <a href="index.html">Inicio</a>
  <a href="digital.html">Digital</a>
  <a href="cart.html" style="position:relative">🛒 Carrito <span id="cart-count">0</span></a>
</nav>

<main>
  <div id="empty" style="display:none; text-align:center; padding:24px 0; color:#445;">
    Tu carrito está vacío.
  </div>

  <table class="table" id="cartTable" style="display:none">
    <thead>
      <tr>
        <th>Producto</th>
        <th class="hide-sm">Imagen</th>
        <th>Categoría</th>
        <th>Precio</th>
        <th>Cantidad</th>
        <th>Subtotal</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div class="total-box" id="totals" style="display:none">
    <strong id="totalTxt"></strong>
    <button class="btn light" id="clearBtn">Vaciar carrito</button>
    <a class="btn" id="mpBtn">Pagar en Mercado Pago</a>
  </div>
</main>

<footer>
  <p>© 2025 Entretalles. Todos los derechos reservados.</p>
  <div class="social">
    <a href="https://www.instagram.com/mgconfecciones.arg/" target="_blank"><img src="https://upload.wikimedia.org/wikipedia/commons/a/a5/Instagram_icon.png"></a>
    <a href="https://wa.me/541133627786" target="_blank"><img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg"></a>
    <a href="https://www.facebook.com/share/17EgVid4V9/?mibextid=wwXIfr" target="_blank"><img src="https://upload.wikimedia.org/wikipedia/commons/1/1b/Facebook_icon.svg"></img></a>
  </div>
</footer>

<!-- MODAL DATOS DEL COMPRADOR -->
<div class="modal-backdrop" id="buyerModal">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="buyerTitle">
    <header><h3 id="buyerTitle" style="margin:0">Datos del comprador</h3></header>
    <div class="content">
      <div class="form-row">
        <label>Nombre y apellido <span class="req">*</span></label>
        <input class="input" id="buyerName" type="text" placeholder="Ej: Marcela Gómez">
      </div>
      <div class="form-row">
        <label>Teléfono <span class="req">*</span></label>
        <input class="input" id="buyerPhone" type="tel" placeholder="Ej: 11 3362 7786">
      </div>
      <div class="form-row">
        <label>Email <span class="req">*</span></label>
        <input class="input" id="buyerEmail" type="email" placeholder="Ej: cliente@mail.com">
      </div>
      <div class="note">Usamos estos datos solo para identificar tu compra y contactarte si hace falta.</div>
      <div class="form-actions">
        <button class="btn light" id="cancelBuyer">Cancelar</button>
        <button class="btn" id="saveBuyer">Continuar</button>
      </div>
    </div>
  </div>
</div>

<script src="cart.js"></script>
<script>
/* =========================
   CONFIGURACIÓN RÁPIDA
   ========================= */
// Si querés que te llegue un mail automático con los datos del comprador + total del carrito,
// creá un formulario en Formspree (gratis) y poné el endpoint acá.
// Cómo: https://formspree.io/  → Create form → te da una URL tipo https://formspree.io/f/xxxxxx
const FORMSPREE_ENDPOINT = ""; // ← si lo dejás vacío, usa mailto de respaldo

// Link de pago directo por alias (mientras no uses preferencia dinámica)
const MP_ALIAS_URL = "https://mpago.la/marcelamodelista";

/* =========================
   CARRITO: Render y acciones
   ========================= */
const tbody = document.getElementById('tbody');
const tbl = document.getElementById('cartTable');
const empty = document.getElementById('empty');
const totals = document.getElementById('totals');
const totalTxt = document.getElementById('totalTxt');
const mpBtn = document.getElementById('mpBtn');
const clearBtn = document.getElementById('clearBtn');

function renderCart(){
  const items = EntretallesCart.all();
  if(!items.length){
    tbl.style.display='none'; totals.style.display='none'; empty.style.display='block';
    EntretallesCart.updateBadge(); return;
  }
  empty.style.display='none'; tbl.style.display='table'; totals.style.display='flex';
  tbody.innerHTML='';
  items.forEach(it=>{
    const subtotal = (Number(it.precio)||0)*it.qty;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${it.nombre}</td>
      <td class="hide-sm"><img class="thumb" src="${it.imagen||''}" alt=""></td>
      <td>${it.categoria||''}</td>
      <td>${EntretallesCart.format(it.precio)}</td>
      <td class="qty">
        <button class="btn light" data-act="dec" data-id="${it.id}">-</button>
        <input type="number" value="${it.qty}" min="1" style="width:60px; text-align:center" data-act="set" data-id="${it.id}">
        <button class="btn light" data-act="inc" data-id="${it.id}">+</button>
      </td>
      <td>${EntretallesCart.format(subtotal)}</td>
      <td class="row-actions"><button class="btn light" data-act="del" data-id="${it.id}">Quitar</button></td>
    `;
    tbody.appendChild(tr);
  });
  totalTxt.textContent = 'TOTAL: ' + EntretallesCart.format(EntretallesCart.total());
  EntretallesCart.updateBadge();
}

tbody.addEventListener('click', e=>{
  const id = e.target.getAttribute('data-id'); const act = e.target.getAttribute('data-act');
  if(!id || !act) return;
  if(act==='del'){ EntretallesCart.remove(id); renderCart(); }
  if(act==='inc'){ const items=EntretallesCart.all(); const it=items.find(x=>x.id===id); EntretallesCart.setQty(id,(it?.qty||1)+1); renderCart(); }
  if(act==='dec'){ const items=EntretallesCart.all(); const it=items.find(x=>x.id===id); EntretallesCart.setQty(id, Math.max(1,(it?.qty||1)-1)); renderCart(); }
});
tbody.addEventListener('change', e=>{
  const id = e.target.getAttribute('data-id'); const act = e.target.getAttribute('data-act');
  if(act==='set' && id){ EntretallesCart.setQty(id, e.target.value); renderCart(); }
});
clearBtn.addEventListener('click', ()=>{ if(confirm('¿Vaciar carrito completo?')){ EntretallesCart.clear(); renderCart(); } });

document.addEventListener('DOMContentLoaded', renderCart);

/* =========================
   PERFIL (icono arriba)
   ========================= */
const buyerModal = document.getElementById('buyerModal');
const openProfile = document.getElementById('openProfile');
const cancelBuyer = document.getElementById('cancelBuyer');
const saveBuyer = document.getElementById('saveBuyer');
const nameInput = document.getElementById('buyerName');
const phoneInput = document.getElementById('buyerPhone');
const emailInput = document.getElementById('buyerEmail');

function loadBuyer(){
  try{
    const data = JSON.parse(localStorage.getItem('entretalles_buyer')||'{}');
    if(data.name) nameInput.value = data.name;
    if(data.phone) phoneInput.value = data.phone;
    if(data.email) emailInput.value = data.email;
  }catch(e){}
}
function showBuyerModal(){ loadBuyer(); buyerModal.style.display='flex'; }
function hideBuyerModal(){ buyerModal.style.display='none'; }

openProfile.addEventListener('click', showBuyerModal);
cancelBuyer.addEventListener('click', hideBuyerModal);
buyerModal.addEventListener('click', e=>{ if(e.target===buyerModal) hideBuyerModal(); });

function validateBuyer(){
  const name = nameInput.value.trim();
  const phone = phoneInput.value.trim();
  const email = emailInput.value.trim();
  const emailOk = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  if(!name){ alert('Completá tu nombre'); return null; }
  if(!phone){ alert('Completá tu teléfono'); return null; }
  if(!emailOk){ alert('Email inválido'); return null; }
  return {name, phone, email};
}

/* =========================
   FINALIZAR COMPRA
   ========================= */
mpBtn.addEventListener('click', async (e)=>{
  e.preventDefault();

  // 1) si no hay datos de comprador, abrir modal
  let buyer = JSON.parse(localStorage.getItem('entretalles_buyer')||'{}');
  if(!buyer.name || !buyer.phone || !buyer.email){
    showBuyerModal();
    // guardamos un flag para saber que venía desde "Pagar"
    localStorage.setItem('entretalles_from_pay', '1');
    return;
  }

  // 2) enviar mail (Formspree o mailto de respaldo)
  const ok = await sendBuyerMail(buyer);
  // aunque falle el mail, seguimos al pago para no frenar la venta
  // 3) redirigir a Mercado Pago (alias)
  window.location.href = MP_ALIAS_URL;
});

// Guardar desde el modal y volver a pagar si venía de “Pagar”
saveBuyer.addEventListener('click', async ()=>{
  const data = validateBuyer();
  if(!data) return;

  localStorage.setItem('entretalles_buyer', JSON.stringify(data));
  hideBuyerModal();

  // Si el modal se abrió porque tocó “Pagar”, completar flujo:
  const fromPay = localStorage.getItem('entretalles_from_pay') === '1';
  localStorage.removeItem('entretalles_from_pay');

  if(fromPay){
    await sendBuyerMail(data); // no bloqueante
    window.location.href = MP_ALIAS_URL;
  }
});

/* =========================
   Envío de email al dueño
   ========================= */
async function sendBuyerMail(buyer){
  try{
    const items = EntretallesCart.all();
    const total = EntretallesCart.total();

    const bodyTxt = [
      'Nueva compra en ENTRETALLES',
      '',
      `Nombre: ${buyer.name}`,
      `Teléfono: ${buyer.phone}`,
      `Email: ${buyer.email}`,
      '',
      'Carrito:',
      ...items.map(i=>`• ${i.categoria} - ${i.nombre} x${i.qty} = $${i.precio}`),
      '',
      `TOTAL: ${EntretallesCart.format(total)}`
    ].join('\n');

    if(FORMSPREE_ENDPOINT){
      const resp = await fetch(FORMSPREE_ENDPOINT, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          message: bodyTxt,
          nombre: buyer.name,
          telefono: buyer.phone,
          email: buyer.email,
          total: total
        })
      });
      // no frenamos la compra si falla
      return resp.ok;
    }else{
      // Respaldo: mailto (abre cliente de correo del usuario)
      const subject = encodeURIComponent('Nueva compra ENTRETALLES');
      const body = encodeURIComponent(bodyTxt);
      // PONÉ TU MAIL AQUÍ:
      const ownerEmail = 'tu_correo@ejemplo.com';
      window.location.href = `mailto:${ownerEmail}?subject=${subject}&body=${body}`;
      return true;
    }
  }catch(e){
    console.warn('Error enviando mail:', e);
    return false;
  }
}
</script>
</body>
</html>
